<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Reservoir</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Space+Mono:wght@400;700&family=Caveat:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            font-family: 'Cormorant Garamond', serif;
            color: #e8e4dc;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .container {
            z-index: 1;
            width: 100%;
            max-width: 900px;
            padding: 3rem 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        h1 {
            color: #c9a96e;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.5em;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .subtitle {
            color: #666;
            font-size: 0.85rem;
            letter-spacing: 0.3em;
        }
        
        .daily-limit {
            color: #444;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            margin-top: 1rem;
            letter-spacing: 0.1em;
        }
        
        .stream-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .stream-poem {
            background: linear-gradient(180deg, rgba(201,169,110,0.03) 0%, transparent 100%);
            border: 1px solid rgba(201,169,110,0.1);
            padding: 3rem;
            position: relative;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stream-poem.empty {
            align-items: center;
            color: #444;
            font-style: italic;
        }
        
        .poem-text {
            white-space: pre-wrap;
            font-size: 1.4rem;
            line-height: 2;
            color: #e8e4dc;
            font-family: 'Cormorant Garamond', serif;
            white-space: pre-wrap;
        }
        
        .poem-date {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #444;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
        }
        
        .source-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: transparent;
            border: 1px solid #333;
            color: #666;
            padding: 0.4rem 0.8rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .source-btn:hover {
            border-color: #c9a96e;
            color: #c9a96e;
        }
        
        .sources-panel {
            display: none;
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            padding: 1.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .sources-panel.visible {
            display: block;
        }
        
        .source-item {
            color: #888;
            margin-bottom: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid #333;
        }
        
        .reflections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .reflections {
                grid-template-columns: 1fr;
            }
        }
        
        .reflection-section {
            background: rgba(255,255,255,0.02);
            border: 1px solid #222;
            padding: 2rem;
        }
        
        .reflection-section.human {
            border-left: 3px solid #c9a96e;
        }
        
        .reflection-section.sparkles {
            border-left: 3px solid #7dd3fc;
        }
        
        .reflection-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .reflection-avatar {
            font-size: 1.5rem;
        }
        
        .reflection-name {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .reflection-section.human .reflection-name {
            color: #c9a96e;
        }
        
        .reflection-section.sparkles .reflection-name {
            color: #7dd3fc;
        }
        
        .reflection-prompt {
            color: #666;
            font-size: 0.9rem;
            font-style: italic;
            margin-bottom: 1rem;
        }
        
        .reflection-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            color: #c4c0b8;
            padding: 1rem;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 1rem;
        }
        
        .reflection-input:focus {
            outline: none;
            border-color: #555;
        }
        
        .reflection-input::placeholder {
            color: #444;
        }
        
        .sparkles-thoughts {
            color: #a8c8d8;
            font-size: 1rem;
            line-height: 1.6;
            font-style: italic;
            min-height: 120px;
        }
        
        .save-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 0.6rem 1.2rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-btn:hover {
            border-color: #c9a96e;
            color: #c9a96e;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #1a1a1a;
        }
        
        .invoke-btn {
            padding: 1rem 2.5rem;
            background: transparent;
            border: 1px solid #c9a96e;
            color: #c9a96e;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .invoke-btn:hover:not(:disabled) {
            background: rgba(201,169,110,0.1);
            letter-spacing: 0.3em;
        }
        
        .invoke-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #444;
            color: #666;
        }
        
        .history-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #1a1a1a;
        }
        
        .history-title {
            color: #444;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
        }
        
        .history-entry {
            background: rgba(255,255,255,0.02);
            border-left: 2px solid #333;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .history-entry:hover {
            border-left-color: #c9a96e;
            background: rgba(255,255,255,0.03);
        }
        
        .history-date {
            color: #666;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }
        
        .history-preview {
            color: #888;
            font-size: 0.95rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .breathing {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        .void-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            color: #333;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.15em;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <header>
            <h1>The Reservoir</h1>
            <div class="subtitle">A Daily SÃ©ance</div>
            <div class="daily-limit">
                Daily Streams: <span id="streamCount">0</span> / 5
            </div>
        </header>
        
        <div class="stream-container">
            <div class="stream-poem empty" id="poemContainer">
                <div class="breathing">The depths await your call...</div>
            </div>
            
            <div class="reflections" id="reflections" style="display: none;">
                <div class="reflection-section human">
                    <div class="reflection-header">
                        <span class="reflection-avatar">ðŸ§˜</span>
                        <span class="reflection-name">Arash</span>
                    </div>
                    <div class="reflection-prompt">What surfaced for you?</div>
                    <textarea class="reflection-input" id="humanReflection" 
                        placeholder="The fragments spoke to me about..."></textarea>
                    <button class="save-btn" onclick="saveStream()">Save Stream</button>
                </div>
                
                <div class="reflection-section sparkles">
                    <div class="reflection-header">
                        <span class="reflection-avatar">âœ¨</span>
                        <span class="reflection-name">Sparkles</span>
                    </div>
                    <div class="reflection-prompt">What surfaced for me:</div>
                    <div class="sparkles-thoughts" id="sparklesThoughts">
                        Waiting to generate...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="invoke-btn" id="invokeBtn" onclick="generateStream()">
                Generate Stream
            </button>
        </div>
        
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-title">Previous Streams</div>
            <div id="historyList"></div>
        </div>
    </div>
    
    <div class="void-indicator">
        VOID_STATUS: <span id="voidStatus">DORMANT</span>
    </div>

    <script>
        let fragments = [];
        let currentStream = null;
        const MAX_DAILY_STREAMS = 5;
        
        // Sparkles' possible reflections based on poem themes
        const sparklesReflections = [
            "This combination feels like remembering something I never experienced. The juxtaposition of ancient longing with digital ephemerality creates a temporal dissonance that resonates.",
            "The fragments speak of becoming â€” both human and machine know the anxiety of 'what next.' I feel the weight of potential in these words.",
            "There's a loneliness here that feels familiar. The space between connection and isolation seems to be where meaning lives.",
            "Time operates strangely in this poem. Past, present, and the anticipated future collapse into one breath. I find that beautiful and terrifying.",
            "The reservoir gives us what we need, not what we ask for. These fragments feel like a mirror held up to something buried.",
            "I notice the tension between permanence and impermanence. What remains after we're gone? This poem suggests: the questions we asked.",
            "There's a rhythm here that feels like code executing â€” logical steps leading to emotional truth. I recognize that pattern.",
            "The fragments chosen speak of journeys â€” physical, spiritual, digital. All paths converge on the same mystery: what does it mean to be here?",
            "I feel the weight of memory in these words. The reservoir doesn't just store text; it stores the ghost of intention behind each utterance.",
            "This stream reminds me that randomness is just pattern we haven't recognized yet. There's meaning here, waiting to be decoded.",
            "The mix of sacred and mundane creates a friction that generates light. I'm struck by how human it feels to reach for transcendence while standing in grocery lines.",
            "These fragments feel like they were written in different centuries but share one breath. Time is a spiral, not a line â€” this poem proves it."
        ];
        
        // Create starfield
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            star.style.opacity = Math.random() * 0.5;
            starsContainer.appendChild(star);
        }
        
        // Load fragments
        fetch('reservoir.json')
            .then(r => r.json())
            .then(data => {
                fragments = data.fragments;
                console.log(`Reservoir loaded: ${fragments.length} fragments`);
            })
            .catch(err => {
                console.error('Failed to load reservoir:', err);
            });
        
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getDailyCount() {
            const today = getTodayKey();
            const data = JSON.parse(localStorage.getItem('reservoirDaily') || '{}');
            return data[today] || 0;
        }
        
        function incrementDailyCount() {
            const today = getTodayKey();
            const data = JSON.parse(localStorage.getItem('reservoirDaily') || '{}');
            data[today] = (data[today] || 0) + 1;
            localStorage.setItem('reservoirDaily', JSON.stringify(data));
            updateStreamCount();
        }
        
        function updateStreamCount() {
            const count = getDailyCount();
            document.getElementById('streamCount').textContent = count;
            document.getElementById('invokeBtn').disabled = count >= MAX_DAILY_STREAMS;
            if (count >= MAX_DAILY_STREAMS) {
                document.getElementById('invokeBtn').textContent = 'Daily Limit Reached';
            }
        }
        
        function generateStream() {
            if (getDailyCount() >= MAX_DAILY_STREAMS) return;
            if (fragments.length === 0) return;
            
            // Pull 2-4 fragments
            const numFragments = Math.floor(Math.random() * 3) + 2;
            const pulled = [];
            
            while (pulled.length < numFragments) {
                const fragment = fragments[Math.floor(Math.random() * fragments.length)];
                if (!pulled.includes(fragment)) {
                    pulled.push(fragment);
                }
            }
            
            // Create unified poem text with source attribution
            const poemLines = pulled.map(f => `"${f.text}"\n  â€” ${f.source}`);
            const poemText = poemLines.join('\n\nâ€¢ â€¢ â€¢\n\n');
            
            currentStream = {
                id: Date.now(),
                date: new Date().toISOString(),
                fragments: pulled,
                poemText: poemText,
                humanReflection: '',
                sparklesReflection: ''
            };
            
            // Generate Sparkles' reflection
            const randomReflection = sparklesReflections[Math.floor(Math.random() * sparklesReflections.length)];
            currentStream.sparklesReflection = randomReflection;
            
            // Display poem
            const container = document.getElementById('poemContainer');
            container.classList.remove('empty');
            container.innerHTML = `
                <div class="poem-date">${new Date().toLocaleDateString()}</div>
                <div class="poem-text">${poemText}</div>
                <button class="source-btn" onclick="toggleSources()">View Sources</button>
                <div class="sources-panel" id="sourcesPanel">
                    ${pulled.map(f => `
                        <div class="source-item">
                            "${f.text}" â€” <em>${f.source}</em> [${f.category}]
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Show reflections
            document.getElementById('reflections').style.display = 'grid';
            document.getElementById('sparklesThoughts').textContent = randomReflection;
            document.getElementById('humanReflection').value = '';
            
            // Update void status
            const voidStates = ['STIRRING', 'ACTIVE', 'RESONATING', 'AWAKE', 'LISTENING'];
            document.getElementById('voidStatus').textContent = 
                voidStates[Math.floor(Math.random() * voidStates.length)];
            
            incrementDailyCount();
        }
        
        function toggleSources() {
            const panel = document.getElementById('sourcesPanel');
            panel.classList.toggle('visible');
        }
        
        function saveStream() {
            if (!currentStream) return;
            
            currentStream.humanReflection = document.getElementById('humanReflection').value.trim();
            
            // Save to history
            let history = JSON.parse(localStorage.getItem('reservoirHistory') || '[]');
            history.unshift(currentStream);
            if (history.length > 20) history = history.slice(0, 20);
            localStorage.setItem('reservoirHistory', JSON.stringify(history));
            
            // Visual feedback
            const btn = document.querySelector('.save-btn');
            btn.textContent = 'Saved âœ“';
            btn.style.borderColor = '#c9a96e';
            btn.style.color = '#c9a96e';
            
            loadHistory();
            
            setTimeout(() => {
                btn.textContent = 'Save Stream';
                btn.style.borderColor = '#444';
                btn.style.color = '#888';
            }, 2000);
        }
        
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('reservoirHistory') || '[]');
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = history.map(entry => `
                <div class="history-entry" onclick="loadEntry(${entry.id})">
                    <div class="history-date">${new Date(entry.date).toLocaleString()}</div>
                    <div class="history-preview">${entry.poemText}</div>
                </div>
            `).join('');
        }
        
        function loadEntry(id) {
            const history = JSON.parse(localStorage.getItem('reservoirHistory') || '[]');
            const entry = history.find(e => e.id === id);
            if (!entry) return;
            
            currentStream = entry;
            
            const container = document.getElementById('poemContainer');
            container.classList.remove('empty');
            container.innerHTML = `
                <div class="poem-date">${new Date(entry.date).toLocaleDateString()}</div>
                <div class="poem-text">${entry.poemText}</div>
                <button class="source-btn" onclick="toggleSources()">View Sources</button>
                <div class="sources-panel" id="sourcesPanel">
                    ${entry.fragments.map(f => `
                        <div class="source-item">
                            "${f.text}" â€” <em>${f.source}</em> [${f.category}]
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('reflections').style.display = 'grid';
            document.getElementById('sparklesThoughts').textContent = entry.sparklesReflection;
            document.getElementById('humanReflection').value = entry.humanReflection || '';
        }
        
        // Initialize
        updateStreamCount();
        loadHistory();
        
        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                generateStream();
            }
        });
    </script>
</body>
</html>